<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>No pains,no gains</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="No pains,no gains">
<meta property="og:url" content="https://mengxu2018.github.io/index.html">
<meta property="og:site_name" content="No pains,no gains">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="No pains,no gains">
  
    <link rel="alternate" href="/atom.xml" title="No pains,no gains" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">No pains,no gains</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://mengxu2018.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-java-servlet" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/26/java-servlet/" class="article-date">
  <time datetime="2019-10-26T03:42:16.000Z" itemprop="datePublished">2019-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/26/java-servlet/">java servlet</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个文章主要说明servlet2.5, 3.0, 3.1的差异</p>
<h2 id="servlet2-5"><a href="#servlet2-5" class="headerlink" title="servlet2.5"></a>servlet2.5</h2><p><img src="/images/tomcat-servlet-version.png" alt="tomcat-nio"><br>tomcat本身在servlet2.5也就是tomcat6的时候就已经实现了nio，但是仅仅在建立连接和解析request header方面nio，这个在上图可以看的很清楚</p>
<h2 id="servlet3-0"><a href="#servlet3-0" class="headerlink" title="servlet3.0"></a>servlet3.0</h2><p>在servlet3.0就是tomcat7以后，实现了异步的servlet，但是这个异步仅仅是对request的处理是异步的，就是将这次请求走到servlet的时候放到一个单独的线程池，不要占用container本身处理请求的线程池。这个感觉提升并不大，因为对request stream io本身还是普通的io, Servlet 3.0 allowed asynchronous request processing but only traditional I/O was permitted. In other words, with Servlet 3.0, only the request processing part became async, but not the I/O for serving the requests and responses. If enough threads block, this results in thread starvation and affects performance. 3.0只能叫异步，3.1才是nio<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import javax.servlet.AsyncContext;</span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.HttpServlet;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">@WebServlet(value = &quot;/simpleAsync&quot;, asyncSupported = true)</span><br><span class="line">public class SimpleAsyncHelloServlet extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">        AsyncContext asyncContext = request.startAsync();</span><br><span class="line"></span><br><span class="line">        asyncContext.start(() -&gt; &#123;</span><br><span class="line">            new LongRunningProcess().run();</span><br><span class="line">            try &#123;</span><br><span class="line">                asyncContext.getResponse().getWriter().write(&quot;Hello World!&quot;);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            asyncContext.complete();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此时，我们先通过request.startAsync()获取到该请求对应的AsyncContext，然后调用AsyncContext的start()方法进行异步处理，处理完毕后需要调用complete()方法告知Servlet容器。start()方法会向Servlet容器另外申请一个新的线程（可以是从Servlet容器中已有的主线程池获取，也可以另外维护一个线程池，不同容器实现可能不一样），然后在这个新的线程中继续处理请求，而原先的线程将被回收到主线程池中。事实上，这种方式对性能的改进不大，因为如果新的线程和初始线程共享同一个线程池的话，相当于闲置下了一个线程，但同时又占用了另一个线程。</p>
<h2 id="servlet3-1"><a href="#servlet3-1" class="headerlink" title="servlet3.1"></a>servlet3.1</h2><p>在servlet3.1后，就是tomcat8以后实现了non blocking io, With Servlet 3.1 NIO, this problem is solved by ReadListener and WriteListener interfaces. These are registered in ServletInputStream and ServletOutputStream. The listeners have callback methods that are invoked when the content is available to be read or can be written without the servlet container blocking on the I/O threads. So these I/O threads are freed up and can now serve other request increasing performance.<br>参考例子 <a href="https://github.com/mengxu2018/java-code-sample/tree/master/servlet3.1" target="_blank" rel="noopener">https://github.com/mengxu2018/java-code-sample/tree/master/servlet3.1</a></p>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p><a href="https://www.cnblogs.com/davenkin/p/async-servlet.html" target="_blank" rel="noopener">https://www.cnblogs.com/davenkin/p/async-servlet.html</a><br><img src="/images/servlet-spec.png" alt="servlet-spec"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/10/26/java-servlet/" data-id="ck272f0uh001ky0ji86jqz9k6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-java-exception" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/26/java-exception/" class="article-date">
  <time datetime="2019-10-26T03:37:23.000Z" itemprop="datePublished">2019-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/26/java-exception/">java exception</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>{<br>status: 1<br>message: “转账成功”<br>data: {} //业务成功有时候会数据返回到前台<br>}<br>{<br>status: 1<br>message: “您的余额不足” //余额不足可以当作正常业务流程提示用户<br>data: {} //业务成功有时候会数据返回到前台<br>}<br>{<br>status: 1<br>message: “您的套餐三个月内不能修改” //套餐不能修改可以当作正常业务流程提示用户<br>data: {} //业务成功有时候会数据返回到前台<br>}<br>{<br>status: 0<br>errorCode: 1001<br>errorMessage: “业务处理出现错误，请稍后再尝试” //数据库错误，socket错误等不应该让用户看到<br>exception: java.xx.socketException,etc<br>}</p>
<p>但是有的业务是需要按照异常给用户的，比如 EmailNotUniqueException, InvalidUserStateException，需要自定义异常<a href="https://stackabuse.com/how-to-make-custom-exceptions-in-java/" target="_blank" rel="noopener">https://stackabuse.com/how-to-make-custom-exceptions-in-java/</a></p>
<p><a href="http://literatejava.com/exceptions/checked-exceptions-javas-biggest-mistake/" target="_blank" rel="noopener">http://literatejava.com/exceptions/checked-exceptions-javas-biggest-mistake/</a><br>这个文章讲解了checked异常的不好的地方</p>
<p><a href="https://stackoverflow.com/questions/7561550/list-of-spring-runtime-exceptions" target="_blank" rel="noopener">https://stackoverflow.com/questions/7561550/list-of-spring-runtime-exceptions</a></p>
<p>spring内部基本都是用的unchecked exception, 因为uncheck exception不需要用户catch，如果有异常就直接输出到日志了，比如说下面的空指针<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NullPointerException: null</span><br><span class="line"> at com.ssc.rest.controller.ManagerControllerMiddleware.delete(ManagerControllerMiddleware.java:61)</span><br><span class="line"> at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line"> at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line"> at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line"> at java.lang.reflect.Method.invoke(Method.java:497)</span><br></pre></td></tr></table></figure></p>
<p>这段话会被输出到日志文件 </p>
<p>一般业务系统的异常都是需要自定义异常，既然自定义异常，那么余额为0或者套餐变更要求不符合还会当作异常被抛出到spring全局处理器然后给js返回错误的数据格式{errormsg:xx, errorCode:xx}？<br>应该是不建议的，定义这种类别的自定义异常不是好的方法,但是不绝对，<br>一般自定义的异常，比如用户名不唯一，邮件格式不对等</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/10/26/java-exception/" data-id="ck272f0ug001iy0jilwa32t8h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-es6-promise" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/26/es6-promise/" class="article-date">
  <time datetime="2019-10-26T03:35:01.000Z" itemprop="datePublished">2019-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/26/es6-promise/">es6 promise</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The arguments to then are optional, and catch(failureCallback) is short for then(null, failureCallback). You might see this expressed with arrow functions instead:</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises</a></p>
<p>下面这个代码可以直接控制台执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line"> console.log(&apos;Initial&apos;);</span><br><span class="line"> throw new Error(&apos;Something failed&apos;);</span><br><span class="line"> // resolve();</span><br><span class="line">&#125;)</span><br><span class="line">.then(() =&gt; &#123;</span><br><span class="line"> // throw new Error(&apos;Something failed&apos;); </span><br><span class="line"> console.log(&apos;Do this&apos;);</span><br><span class="line">&#125;)</span><br><span class="line">.then(null,</span><br><span class="line"> () =&gt; &#123;</span><br><span class="line"> // throw new Error(&apos;Something failed&apos;); </span><br><span class="line"> console.log(&apos;Do that&apos;);</span><br><span class="line"> &#125;</span><br><span class="line"> )</span><br><span class="line">.then(() =&gt; &#123;</span><br><span class="line"> console.log(&apos;Do this, no matter what happened before&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>上面这个代码等同于<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line"> console.log(&apos;Initial&apos;);</span><br><span class="line"> throw new Error(&apos;Something failed&apos;);</span><br><span class="line"> // resolve();</span><br><span class="line">&#125;)</span><br><span class="line">.then(() =&gt; &#123;</span><br><span class="line"> // throw new Error(&apos;Something failed&apos;); </span><br><span class="line"> console.log(&apos;Do this&apos;);</span><br><span class="line">&#125;)</span><br><span class="line">.catch(() =&gt; &#123;</span><br><span class="line"> console.error(&apos;Do that&apos;);</span><br><span class="line">&#125;)</span><br><span class="line">.then(() =&gt; &#123;</span><br><span class="line"> console.log(&apos;Do this, no matter what happened before&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>When you return something from a then() callback, it’s a bit magic. If you return a value, the next then() is called with that value. However, if you return something promise-like, the next then() waits on it, and is only called when that promise settles (succeeds/fails).<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Promise.resolve(&apos;foo&apos;).</span><br><span class="line"> then(() =&gt; &#123;return &quot;bar&quot;&#125;).</span><br><span class="line"> then((v) =&gt; console.log(v))</span><br><span class="line">Promise.resolve(&apos;foo&apos;).</span><br><span class="line"> then(() =&gt; &#123;return Promise.resolve(&apos;bar&apos;)&#125;).</span><br><span class="line"> then((v) =&gt; console.log(v))</span><br></pre></td></tr></table></figure></p>
<p><a href="https://stackoverflow.com/questions/34094806/return-from-a-promise-then" target="_blank" rel="noopener">https://stackoverflow.com/questions/34094806/return-from-a-promise-then</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/10/26/es6-promise/" data-id="ck272f0ty000ny0jihc8i8rxu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jvm-classloader" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/26/jvm-classloader/" class="article-date">
  <time datetime="2019-10-26T03:33:41.000Z" itemprop="datePublished">2019-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/26/jvm-classloader/">jvm classloader</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html" target="_blank" rel="noopener">https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html</a></p>
<p>关于Sharedclassloader 有个没说清楚， webappclassloader会先从自己的repository寻找，找不到才会从Sharedclassloader寻找</p>
<p>log4j:ERROR A “org.apache.log4j.DailyRollingFileAppender” object is not assignable to a “org.apache.log4j.Appender” variable.<br>log4j:ERROR The class “org.apache.log4j.Appender” was loaded by<br>log4j:ERROR [java.net.URLClassLoader@2f0a098b] whereas object of type<br>log4j:ERROR “org.apache.log4j.DailyRollingFileAppender” was loaded by [WebappClassLoader<br> context: /cdt4middleware<br> delegate: false<br> repositories:<br> /WEB-INF/classes/<br> - - - - → Parent Classloader:<br>java.net.URLClassLoader@2f0a098b<br>].<br>log4j:ERROR Could not instantiate appender named “RollingAppender”.</p>
<p>这个错误是因为webapp下面有个log4j，而且sharedclassloader下面也有个log4j<br>因为osa框架里面的类是由sharedclassloader加载的，他如果事先加载了org.apache.log4j.Appender，而后如果DailyRollingFileAppender被webappclassloader加载的话就会报这个错误了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/10/26/jvm-classloader/" data-id="ck272f0uj001py0jixojx21ro" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jvm/">jvm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jdk8-new-features" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/11/jdk8-new-features/" class="article-date">
  <time datetime="2019-08-11T05:27:07.000Z" itemprop="datePublished">2019-08-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/11/jdk8-new-features/">jdk8 new features</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="为什么jdk8的interface要引入default-method"><a href="#为什么jdk8的interface要引入default-method" class="headerlink" title="为什么jdk8的interface要引入default method?"></a>为什么jdk8的interface要引入default method?</h3><p>To give you an example take the case of the Collection.forEach method, which is designed to take an instance of the Consumer functional interface and has a default implementation in the Collection interface:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">default void forEach(Consumer&lt;? super T&gt; action) &#123;</span><br><span class="line">    Objects.requireNonNull(action);</span><br><span class="line">    for (T t : this) &#123;</span><br><span class="line">        action.accept(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the JDK designers didn’t introduce the concept of default methods then all the implementing classes of the Collection interface would have to implement the forEach method so it would be problematic to switch to Java - 8 without breaking your code.</p>
<p>So to facilitate the adoption of lambdas and the use of the new functional interfaces like Consumer, Supplier, Predicate, etc. the JDK designers introduced the concept of default methods to provide backward compatibility and it is now easier to switch to Java - 8 without making any changes.</p>
<p>If you don’t like the default implementation in the interface you can override it and supply your own.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/08/11/jdk8-new-features/" data-id="ck272f0ui001my0jig092v23a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-FileChannel-ByteBuffer" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/11/FileChannel-ByteBuffer/" class="article-date">
  <time datetime="2019-08-11T05:17:41.000Z" itemprop="datePublished">2019-08-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/11/FileChannel-ByteBuffer/">FileChannel ByteBuffer</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>FileChannel示例代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class FileChannelWriter &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String file = &quot;test_write_using_filechannel.txt&quot;;</span><br><span class="line">        try (RandomAccessFile writer = new RandomAccessFile(file, &quot;rw&quot;);</span><br><span class="line">             FileChannel channel = writer.getChannel()) &#123;</span><br><span class="line">            ByteBuffer buff = ByteBuffer.wrap(&quot;Hello&quot;.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">            channel.write(buff);</span><br><span class="line">            System.out.println(channel.position());</span><br><span class="line"></span><br><span class="line">            System.out.println(buff.position());</span><br><span class="line">//            ByteBuffer buff2 = ByteBuffer.wrap(&quot;Hello world&quot;.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            channel.position(3);</span><br><span class="line">            buff.position(4);</span><br><span class="line">            System.out.println(channel.position());</span><br><span class="line">            channel.write(buff);</span><br><span class="line">            System.out.println(channel.position());</span><br><span class="line"></span><br><span class="line">            // verify</span><br><span class="line">            RandomAccessFile reader = new RandomAccessFile(file, &quot;r&quot;);</span><br><span class="line">            System.out.println(reader.readLine());</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现channel写buffer的时候buffer自己的文件指针也随着变化 ，position如果是11，下次读写从12开始</p>
<p><a href="https://medium.com/@xunnan.xu/its-all-about-buffers-zero-copy-mmap-and-java-nio-50f2a1bfc05c" target="_blank" rel="noopener">https://medium.com/@xunnan.xu/its-all-about-buffers-zero-copy-mmap-and-java-nio-50f2a1bfc05c</a></p>
<p>linux sendfile是用来实现zero-copy的，就是java的FileChannel.transferTo<br>linux epoll是用来实现nio的selector的<br>前者是网络传输增强性能避免用户空间的buffer的，后者是io的模型用来减少所需要的线程数量</p>
<p><a href="http://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="noopener">http://man7.org/linux/man-pages/man7/epoll.7.html</a><br>The epoll API performs a similar task to poll(2): monitoring multiple file descriptors to see if I/O is possible on any of them.  The epoll API can be used either as an edge-triggered or a level-triggered interface and scales well to large numbers of watched file descriptors.</p>
<p>A new java.nio.channels.SelectorProvider implementation that is based on the Linux epoll event notification facility is included<br>If linux kernel &gt;= 2.6 is detected, then the java.nio.channels.spi.SelectorProvider will use epoll.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Selector open() throws IOException &#123;</span><br><span class="line">    return SelectorProvider.provider().openSelector();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.baeldung.com/java-nio-selector" target="_blank" rel="noopener">https://www.baeldung.com/java-nio-selector</a><br><a href="https://github.com/mengxu2018/java-code-sample/tree/master/simple-nio/src/com/xu/nio/EchoTest.java" target="_blank" rel="noopener">https://github.com/mengxu2018/java-code-sample/tree/master/simple-nio/src/com/xu/nio/EchoTest.java</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/08/11/FileChannel-ByteBuffer/" data-id="ck272f0tg0003y0jip7kio5nj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IO/">IO</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kafka源码开发环境" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/10/kafka源码开发环境/" class="article-date">
  <time datetime="2019-08-10T13:43:59.000Z" itemprop="datePublished">2019-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/10/kafka源码开发环境/">kafka源码开发环境</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>cd kafka_source_dir<br>gradle</p>
<p>./gradlew jar （如果不能下载wrapper可以直接用local的gradle命令)<br>./gradlew idea</p>
<h2 id="去掉编译warning（build-gradle"><a href="#去掉编译warning（build-gradle" class="headerlink" title="去掉编译warning（build.gradle)"></a>去掉编译warning（build.gradle)</h2><p>tasks.withType(JavaCompile) {<br>      options.encoding = ‘UTF-8’<br>增加  options.warnings = false   </p>
<h2 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h2><p>把config下面的log4j.properties文件copy到kafka-2.3.0-src\core\src\main\resources\log4j.properties<br>同时修改config下面的server.properties的log.dirs=c:/tmp/kafka-logs</p>
<h2 id="启动windows-zookeeper"><a href="#启动windows-zookeeper" class="headerlink" title="启动windows zookeeper"></a>启动windows zookeeper</h2><p>直接执行zkServer.cmd（提前修改zoo.cfg的路径为windows路径)</p>
<h2 id="导入intellij"><a href="#导入intellij" class="headerlink" title="导入intellij"></a>导入intellij</h2><p>intellij open然后选择kafka-2.3.0-src\build.gradle</p>
<p>修改classpath<br><img src="/images/kakfa-build.PNG" alt="kakfa-build"><br>注意箭头的地方</p>
<p>运行main方法，注意-Dkafka.logs.dir=c:/tmp/log4j-kafka-logs是针对的log4j.properties,<br>和log.dirs=c:/tmp/kafka-logs里面的不一样<br><img src="/images/kafka-main.PNG" alt="kakfa-main"></p>
<h2 id="查错"><a href="#查错" class="headerlink" title="查错"></a>查错</h2><p>java.io.IOException: No snapshot found, but there are log entries. Something，清空zoo.cfg所配置的dataDir目录下面的东西</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/08/10/kafka源码开发环境/" data-id="ck272f0uu002dy0ji6c81nii0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/">kafka</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kafka-client-sample" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/10/kafka-client-sample/" class="article-date">
  <time datetime="2019-08-10T12:35:58.000Z" itemprop="datePublished">2019-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/10/kafka-client-sample/">kafka client sample</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/mengxu2018/kafka-sample" target="_blank" rel="noopener">https://github.com/mengxu2018/kafka-sample</a><br>例子在 producer/src/main/java/kafka/examples/xuhang/<br>包含一个producer，两个consumer group</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/08/10/kafka-client-sample/" data-id="ck272f0uo001zy0jilt5puueb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/">kafka</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-issues" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/10/linux-issues/" class="article-date">
  <time datetime="2019-08-10T12:31:52.000Z" itemprop="datePublished">2019-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/10/linux-issues/">linux issues</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天遇到了新机器yum一直不成功，需要安装几个工具<br>sudo yum update<br>sudo yum install yum-utils<br>sudo yum groupinstall development</p>
<p>另外/etc/resolv.conf也有问题，可以加个nameserver 9.9.9.9</p>
<p>pip3.6 install torch torchvision</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/08/10/linux-issues/" data-id="ck272f0v3002qy0jit36qslqd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kafka-cluster-setup" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/03/kafka-cluster-setup/" class="article-date">
  <time datetime="2019-08-03T06:40:56.000Z" itemprop="datePublished">2019-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/03/kafka-cluster-setup/">kafka cluster setup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>bin/kafka-server-start.sh -daemon config/server.properties<br>bin/kafka-server-stop.sh</p>
<p>broker.id不要写错</p>
<p>而且启动日志开头打印了[2019-08-03 04:36:30,484] INFO Client environment:host.name=218.93.250.18 (org.apache.zookeeper.ZooKeeper)很奇怪，这个是<br> try {<br>            put(l, “host.name”,<br>                InetAddress.getLocalHost().getCanonicalHostName());<br>        } catch (UnknownHostException e) {<br>            put(l, “host.name”, “<na>“);<br>        }<br>只有第一个机器正常<br>[2019-08-03 04:35:41,120] INFO Client environment:host.name=k8s-master (org.apache.zookeeper.ZooKeeper)</na></p>
<p>所以listeners=PLAINTEXT://192.168.77.132:9092 写ip才可以，hostname就不行</p>
<p>producer发送完成需要close</p>
<p><strong>consumer</strong>offsets何时创建?用户启动了一个消费者组(下称consumer group)进行消费或调用kafka-consumer-groups –describe等<br><a href="https://www.cnblogs.com/huxi2b/p/8316289.html" target="_blank" rel="noopener">https://www.cnblogs.com/huxi2b/p/8316289.html</a></p>
<p><a href="https://kafka.apache.org/23/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html" target="_blank" rel="noopener">https://kafka.apache.org/23/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html</a></p>
<p> bin/kafka-topics.sh –create –bootstrap-server k8s-master:9092 –replication-factor 2 –partitions 6 –topic my-replicated-topic2<br> 这个可以在任意一台集群机器执行，执行后可以看到每台机器都有4个 my-replicated-topic2-x的文件夹，有两个是replication，<br> 每个replication都有一个leader</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mengxu2018.github.io/2019/08/03/kafka-cluster-setup/" data-id="ck272f0up0021y0jixiuecl23" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AI/">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/">IO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/">OS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloud/">cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/">grpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hardware/">hardware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/">hbase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/search/">search</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/">spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/win10/">win10</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/OS/" style="font-size: 16px;">OS</a> <a href="/tags/cloud/" style="font-size: 10px;">cloud</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/docker/" style="font-size: 12px;">docker</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hadoop/" style="font-size: 10px;">hadoop</a> <a href="/tags/hardware/" style="font-size: 12px;">hardware</a> <a href="/tags/hbase/" style="font-size: 10px;">hbase</a> <a href="/tags/java/" style="font-size: 18px;">java</a> <a href="/tags/javascript/" style="font-size: 12px;">javascript</a> <a href="/tags/jvm/" style="font-size: 12px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/kubernetes/" style="font-size: 14px;">kubernetes</a> <a href="/tags/linux/" style="font-size: 16px;">linux</a> <a href="/tags/maven/" style="font-size: 12px;">maven</a> <a href="/tags/mongodb/" style="font-size: 10px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/search/" style="font-size: 12px;">search</a> <a href="/tags/security/" style="font-size: 14px;">security</a> <a href="/tags/spark/" style="font-size: 20px;">spark</a> <a href="/tags/spring/" style="font-size: 14px;">spring</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/win10/" style="font-size: 10px;">win10</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/10/26/java-servlet/">java servlet</a>
          </li>
        
          <li>
            <a href="/2019/10/26/java-exception/">java exception</a>
          </li>
        
          <li>
            <a href="/2019/10/26/es6-promise/">es6 promise</a>
          </li>
        
          <li>
            <a href="/2019/10/26/jvm-classloader/">jvm classloader</a>
          </li>
        
          <li>
            <a href="/2019/08/11/jdk8-new-features/">jdk8 new features</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 xu, hang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>